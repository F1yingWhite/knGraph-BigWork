import json

import requests

API_URL = "http://10.130.128.54:11434/v1/chat/completions"
MODEL_NAME = "qwen3:32b"


EXAMPLE_TEXT = """
一枝黄花
Yizhihuanghua
SOLIDAGINISHERBA
本品为菊科植物一枝黄花SolidagodecurrensLour.的干燥全草。秋季花果期采挖，除去泥沙，晒干。
【性状】本品长30～lOOcm。根茎短粗，簇生淡黄色细根。茎圆柱形，直径～；表面黄绿色、灰棕色或暗紫红色，有棱线，上部被毛；质脆，易折断，断面纤维性，有髓。单叶互生，多皱缩、破碎，完整叶片展平后呈卵形或披针形，长1～9cm，宽～；先端稍尖或钝，全缘或有不规则的疏锯齿，基部下延成柄。头状花序直径约，排成总状，偶有黄色舌状花残留，多皱缩扭曲，苞片3层，卵状披针形。瘦果细小，冠毛黄白色。气微香，味微苦辛。
【鉴别】(1)叶表面观：上表皮细胞多角形，垂周壁略呈念珠状增厚。下表皮细胞垂周壁波状弯曲，气孔不定式，略下陷。非腺毛有两类：表皮非腺毛由3个细胞组成，壁薄，顶端1个细胞常萎缩成鼠尾状，较小；叶缘非腺毛睫毛状由3～7个细胞组成，壁稍厚，长180～500μm。
(2)取本品粉末2g，加石油醚（60～90℃）50ml，超声处理30分钟，放冷，滤过，弃去石油醚液，药渣挥干溶剂，加70%乙醇30ml，加热回流1小时，放冷，滤过，滤液蒸干，残渣加甲醇1ml使溶解，作为供试品溶液。另取一枝黄花对照药材2g，同法制成对照药材溶液。再取芦丁对照品，加甲醇制成每1ml含的溶液，作为对照品溶液。照薄层色谱法（附录ⅥB)试验，吸取供试品溶液5～10μl、对照药材溶液和对照品溶液各5μl，分别点于同一以含4%磷酸氢二钠溶液制备的硅胶G薄层板上，以乙酸乙酯-甲醇-甲酸-水（8：1：1：1）为展示剂，展开，取出，晾干，喷以3%三氯化铝乙醇溶液，晾干，置紫外光灯（365nm）下检视，供试品色谱中，在与对照药材色谱和对照品色谱相应的位置上，显相同颜色的荧光斑点。；再喷以5%三氯化铁乙醇溶液，供试品色谱中，在与对照药材色谱和对照品色谱相应的位置上，显相同颜色的斑点。
【性味与归经】辛、苦，凉。归肺、肝经。
【功能与主治】清热解毒，疏散风热。用于喉痹，乳蛾，咽喉肿痛，疮疖肿毒，风热感冒。
"""

EXAMPLE_OUTPUT = {
    "药物名称": ["一枝黄花"],
    "基原生物": ["菊科", "一枝黄花"],
    "药用部位": ["干燥全草", "根茎", "根", "茎", "单叶", "头状花序", "舌状花", "苞片", "瘦果", "冠毛"],
    "化学成分": ["芦丁"],
    "实验试剂与材料": [
        "石油醚",
        "乙醇",
        "甲醇",
        "磷酸氢二钠",
        "硅胶G",
        "乙酸乙酯",
        "甲酸",
        "水",
        "三氯化铝",
        "三氯化铁",
    ],
    "微观结构": ["上表皮细胞", "下表皮细胞", "气孔", "非腺毛", "纤维", "髓"],
    "中药药性": ["辛", "苦", "凉"],
    "归经": ["肺经", "肝经"],
    "功效": ["清热解毒", "疏散风热"],
    "适应症": ["喉痹", "乳蛾", "咽喉肿痛", "疮疖肿毒", "风热感冒"],
    "分析方法": ["薄层色谱法"],
}


# 2. 定义包含示例的请求函数
def call_ollama_with_example(task_name, instruction, schema, input_text):
    # 构建 Prompt：
    # 结构：[指令] -> [Schema] -> [One-Shot Example] -> [实际任务]
    user_prompt = f"""
### 任务指令
{instruction}

### 目标 Schema (请严格按照此定义提取)
{json.dumps(schema, ensure_ascii=False, indent=2)}

### 学习示例 (One-Shot Example)
为了帮助你理解任务，请参考以下示例：

**示例输入文本：**
{EXAMPLE_TEXT}

**示例输出 JSON：**
{json.dumps(EXAMPLE_OUTPUT, ensure_ascii=False, indent=2)}

---
### 现在开始处理新的任务
请根据上述 Schema 和 示例风格，处理以下文本：

**待处理文本：**
{input_text}
"""

    # 系统提示词：极其严格的格式约束
    system_prompt = (
        "你是一个中药领域的知识图谱构建专家。请根据用户的指令和Schema从文本中提取信息。忽略英文的名称和缩写，只关注中文内容。"
        "输出必须是严格的JSON格式，不要包含Markdown代码块标记（如 ```json），不要包含任何解释性文字。"
    )

    payload = {
        "model": MODEL_NAME,
        "messages": [{"role": "system", "content": system_prompt}, {"role": "user", "content": user_prompt}],
        "stream": False,
        "format": "json",  # 强制开启 Ollama 的 JSON 模式
        "options": {"temperature": 0},  # 温度设为0，确保最稳定的复现
    }

    response = requests.post(API_URL, json=payload)
    response.raise_for_status()
    result_content = response.json()["choices"][0]["message"]["content"]

    return result_content


entity_schema_definitions = {
    "药物名称": "提取中药正名、别名、拼音及拉丁名。",
    "基原生物": "提取来源植物/动物的科名、属名、种名及拉丁学名。",
    "药用部位": "提取作为药用的器官或部位。",
    "化学成分": "提取药材固有的化学物质（如芦丁），不包含外部试剂。",
    "实验试剂与材料": "提取检测过程中使用的人为添加试剂（如甲醇、硅胶）。",
    "微观结构": "提取显微鉴别中的组织构造（如气孔、导管）。",
    "中药药性": "提取四气五味（如辛、温）。",
    "归经": "提取归属经络。",
    "功效": "提取治疗功能的动词短语。",
    "适应症": "提取主治的疾病或症状。",
    "分析方法": "提取提及的实验检测技术名称。",
    "其他": "提取不属于上述类别但符合实体定义的其他重要信息。",
}

entity_instruction = "请分析文本，提取符合 Schema 定义的实体。严格区分'化学成分'与'实验试剂'。"

test_input_text = """
人工牛黄
本品由牛胆粉、胆酸、猪去氧胆酸、牛磺酸、胆红素、胆固醇、微量元素等加工制成。
【性状】本品为黄色疏松粉末。味苦，微甘。
【鉴别】(1)取胆红素[含量测定]项下溶液，照紫外-可见分光光度法(附录VA)测定，在453nm波长处有最大吸收。
(2)取本品，置lOml量瓶中，加甲醇适量，超声处理5分钟，加甲醇稀释至刻度，摇匀，静置，取上清液作为供试品溶液。另取胆酸对照品、猪去氧胆酸对照品，加甲醇制成每1ml各含1mg的混合溶液，作为财照品溶液。照薄层色谱法（附录ⅥB）试验，吸取供试品溶液4μl、对照品溶液2μl，分别点于同一硅胶G薄层板上，以正己烷-乙酸乙酯-醋酸-甲醇(20：25；2：3)上层溶液为展开剂，展开，取出，晾干，喷以10%磷钼酸乙醇溶液，在105℃加热至斑点显色清晰。供试品色谱中，在与对照品色谱相应的位置上，显相同颜色的斑点。
(3)取牛胆粉对照药材lOmg，加甲醇适量，超声处理使充分溶解，再加甲醇至lOml，摇匀，静置，取上清液作为对照药材溶液。照薄层色谱法(附录ⅥB)试验，吸取[鉴别](2)项下的供试品溶液和上述对照药材溶液各8μl，分别点于同一硅胶G薄层板上，以甲苯一冰醋酸水：10：为展开剂，展开，取出，晾干，喷以10%磷钼酸乙醇溶液，在105℃加热至斑点显色清晰。供试品色谱中，在与对照药材色谱相应的位置上，显相同颜色的斑点。
(4)取本品50mg，加水5ml，超声处理5分钟，加甲醇至lOml，静置，取上清液作为供试品溶液。另取牛磺酸对照品，加甲醇制成每1ml含的溶液，作为对照品溶液。照薄层色谱法（附录ⅥB）试验，吸取上述两种溶液各2μl，分别点于同一硅胶G薄层板上，以正丁醇-乙醇-冰醋酸-水(4：1：2：1)为展开剂，展开，取出，晾干，在105℃加热10分钟，喷以1%茚三酮乙醇溶液，在105℃加热至斑点显色清晰。供试品色谱中，在与对照品色谱相应的位置上，显相同颜色的斑点。
【检查】水分不得过%（附录ⅨH第一法）。
【含量测定】胆酸对照品溶液的制备取胆酸对照品，精密称定，置25ml量瓶中，加60%冰醋酸溶液使溶解，并稀释至刻度，摇匀，即得(每1ml中含胆酸。
标准曲线的制备精密量取对照品溶液、、、、1ml分别置具塞试管中，各管加入60%冰醋酸溶液稀释成，再分别加新制的糠醛溶液(1→100)，摇匀，在冰浴中放置5分钟,精密加入硫酸溶液(取硫酸50ml与水65ml混合)13ml,混匀,在700C水浴中加热10分钟，迅速移至冰浴中,放置2分钟，以相应试剂为空白，照紫外-可见分光光度法（附录VA），在605nm的波长处测定吸光度，以吸光度为纵坐标，浓度为横坐标，绘制标准曲线。
测定法取本品约，精密称定，置50ml量瓶中，加60%冰醋酸溶液适量,超声处理5分钟,用60%冰醋酸溶液稀释至刻度,摇匀,滤过,弃去初滤液,精密量取续滤液各1ml，分别置甲、乙两个具塞试管中，于甲管中加新制的糠醛溶液1ml，乙管中加水1ml作空白，照标准曲线的制备项下的方法，自“在冰浴中放置5分钟”起，依法测定吸光度，从标准曲线上读出供试品溶液中含胆酸的重量（mg），计算，即得。
本品按干燥品计算，含胆酸(C24H40O5)不得少于%。
胆红素对照品溶液的制备取胆红素对照品10mg，精密称定,置100ml棕色量瓶中，加三氯甲烷80ml，超声处理使充分溶解,加三氯甲烷稀释至刻度，摇匀，精密量取10ml，置50ml棕色量瓶中，用三氯甲烷稀释至刻度，摇匀，即得（每1ml中含胆红素20μg）。
标准曲线的制备精密量取对照品溶液4ml、5ml、6ml、7ml、8ml分别置具25ml棕色量瓶中，用三氯甲烷稀释至刻度，摇匀，照紫外-可见分光光度法（附录VA），在453nm的波长处测定吸光度，以吸光度为纵坐标，浓度为横坐标，绘制标准曲线。
测定法取本品约80mg，精密称定，置100ml棕色量瓶中，加三氯甲烷80ml超声处理使充分溶解,用三氯甲烷稀释至刻度，摇匀,滤过,弃去初滤液,取续滤液，在453nm的波长处测定吸光度，从标准曲线上读出供试品溶液中含胆红素的重量（mg），计算，即得。
本品按干燥品计算，含胆红素(C33H36N4O6)不得少于%。
【性味与归经】甘，凉。归心、肝经。
【功能与主治】清热解毒，化痰定惊。用于痰热谵狂，神昏不语，小儿急惊风，咽喉肿痛，口舌生疮，痈肿疔疮。
【用法与用量】一次～，多作配方用。外用适量敷患处。
【注意】孕妇慎用。
【贮藏】密封，防潮，避光，置阴凉处。
"""

# 4. 调用
print(call_ollama_with_example("基于示例的实体抽取", entity_instruction, entity_schema_definitions, test_input_text))
